\section{Handling conflicts}
\begin{frame}[fragile]
  \slidetitle
  This section covers the following topics:
  \begin{itemize}
    \item Solve merge conflicts
    \item Using diff tools
    \item 3 way merge
  \end{itemize}
\end{frame}

\subsection{Prepare a merge conflict}
\begin{frame}[fragile]
  \subslidetitle
  Implement the change in \cmd{moon.js} following this diff:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{@@ -4,7 +4,7 @@}*) var moons = [];
 init();
 moon( "blue" );
 moon( "white" );
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{moon( "green" );}*)
(*\textcolor[HTML]{00AA00}{+}*)(*\textcolor[HTML]{00AA00}{moon( "red" );}*)
 animate();
\end{lstlisting}

  Commit your changes on master:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*) $ (*\textcolor[HTML]{0000AA}{git commit -a -m "change the green moon to red"}*)
\end{lstlisting}

\end{frame}

\subsection{Prepare a merge conflict}
\begin{frame}[fragile]
  \subslidetitle

  Switch to the branch third-moon:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*) $ (*\textcolor[HTML]{0000AA}{git checkout third-moon}*)
\end{lstlisting}

  Add a comment to the green moon like defined in the following diff:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{@@ -4,7 +4,7 @@}*) var moons = [];
 init();
 moon( "blue" );
 moon( "white" );
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{moon( "green" );}*)
(*\textcolor[HTML]{00AA00}{+}*)(*\textcolor[HTML]{00AA00}{moon( "green" ); // the moon was greener}*)
 animate();
\end{lstlisting}

  Commit your changes:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*) $ (*\textcolor[HTML]{0000AA}{git commit -a -m "comment on green moon"}*)
\end{lstlisting}
\end{frame}

\subsection{Prepare a merge conflict}
\begin{frame}[fragile]
  \subslidetitle

  Let's merge the third-moon branch to master:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(third-moon)}*) $ (*\textcolor[HTML]{0000AA}{git checkout master}*)
Switched to branch 'master'
Your branch is ahead of 'origin/master' by 10 commits.
  (use "git push" to publish your local commits)

(*\textcolor[HTML]{18B2B2}{(master)}*) $ (*\textcolor[HTML]{0000AA}{git merge third-moon}*)
Auto-merging moon.js
CONFLICT (content): Merge conflict in moon.js
Automatic merge failed; fix conflicts and then commit the result.
\end{lstlisting}
  \vspace{1em}
  Here we go, our first conflict, keep calm, do not panic, we are using \cmd{git}!
\end{frame}

\subsection{Displaying conflicts}
\begin{frame}[fragile]
  \subslidetitle

  First we want to display the conflicting file with \cmd{git difftool}:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|MERGING)}*) $ (*\textcolor[HTML]{0000AA}{git difftool}*)
diff --cc moon.js
index 72886cb,861507e..0000000
--- a/moon.js
+++ b/moon.js
(*\textcolor[HTML]{18B2B2}{@@@ -4,7 -4,7 +4,11 @@@}*) var moons = []
  init();
  moon( "blue" );
  moon( "white" );
(*\textcolor[HTML]{00AA00}{++}*)(*\textcolor[HTML]{00AA00}{<<<<<<< HEAD}*)
(*\textcolor[HTML]{00AA00}{+}*) (*\textcolor[HTML]{00AA00}{moon( "red" );}*)
(*\textcolor[HTML]{00AA00}{++}*)(*\textcolor[HTML]{00AA00}{=======}*)
(*\textcolor[HTML]{00AA00}{+}*) (*\textcolor[HTML]{00AA00}{moon( "green" ); // the moon was greener}*)
(*\textcolor[HTML]{00AA00}{++}*)(*\textcolor[HTML]{00AA00}{>>>>>>> third-moon}*)
  animate();
\end{lstlisting}
\end{frame}

\subsection{Resolving conflicts}
\begin{frame}[fragile]
  \subslidetitle
  Use \cmd{git mergetool} and select an external merge tool like kdiff3, vimdiff to resolve a conflict:

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|MERGING)}*) $ (*\textcolor[HTML]{0000AA}{git mergetool}*)
Merging:
moon.js

Normal merge conflict for 'moon.js':
  {local}: modified file
  {remote}: modified file
\end{lstlisting}

\end{frame}

\subsection{Three way merge}
\begin{frame}[fragile]
  \subslidetitle
  Have a look at the \cmd{kdiff3} application, right click on the \textcolor{red}{?<Merge Conflict>} and select the appropriate resolution:
  \newline \vspace{1em}
  \centerline{\includegraphics[width=8cm]{../screen/kdiff3.png}}

  Let's select \textbf{B}, save and quite kdiff3.
\end{frame}

\subsection{Finishing a merge}
\begin{frame}[fragile]
  \subslidetitle
  The \cmd{git status} gives some hints how to finalize the merge conflict resolution:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|MERGING)}*) $ (*\textcolor[HTML]{0000AA}{git status}*)
On branch master
Your branch is ahead of 'origin/master' by 1 commit.
  (use "git push" to publish your local commits)
All conflicts fixed but you are still merging.
  (use "git commit" to conclude merge)
...
\end{lstlisting}
\end{frame}

\subsection{Finishing a merge}
\begin{frame}[fragile]
  \subslidetitle

  Just use \cmd{git commit} to finish the merge, this will automatically open the text editor:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|MERGING)}*) $ (*\textcolor[HTML]{0000AA}{git commit}*)
Merge branch 'third-moon' into master
# Conflicts:
#       moon.js
\end{lstlisting}
  Save and quit the editor.
  \\
  \vspace{1em}
  You successfully resolved you first conflict with git, not so difficult !?

\end{frame}

% make rebase conflict and use stashing
\subsection{Preparing rebase conflict}
\begin{frame}[fragile]
  \subslidetitle

  Create a new \cmd{death-star} branch:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*)$ (*\textcolor[HTML]{0000AA}{git checkout -b death-star master}*)
Switched to a new branch 'death-star'
\end{lstlisting}

  Implement the change in \cmd{moon.js} following this diff:

  \begin{lstlisting}
 moon( "red" );
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{moon( "white" );}*)
(*\textcolor[HTML]{00AA00}{+}*)(*\textcolor[HTML]{00AA00}{moon( "black" );}*)
 animate();
\end{lstlisting}

  Commit the change:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git commit -a -m "add black moon"}*)
[death-star 2670288] add black moon
 1 file changed, 1 insertion(+), 1 deletion(-)
\end{lstlisting}
\end{frame}

\subsection{Stashing modifications}
\begin{frame}[fragile]
  \subslidetitle

  Edit the README file:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{echo "\#\# The Death star" >> README}
\end{lstlisting}

  Imagine you are in the middle of a modification.

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git status}*)
...
       (*\textcolor[HTML]{AA0000}{modified:   README}*)
...
\end{lstlisting}

  And suddenly something really important needs to be done immediately on master!

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git checkout master}*)
error: Your local changes to the following files would be overwritten by checkout:
	README
Please, commit your changes or stash them before you can switch branches.
Aborting
\end{lstlisting}
\end{frame}

\subsection{Stashing modifications}
\begin{frame}[fragile]
  \subslidetitle

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git stash}*)
Saved working directory and index state WIP on death-star: 2670288 add black moon
HEAD is now at 2670288 add black moon
$ (*\textcolor[HTML]{0000AA}{git status}*)
# On branch death-star
nothing to commit (working directory clean)
\end{lstlisting}
  Note: you now have a clean working directory again.
\end{frame}

\subsection{Display stash stack}
\begin{frame}[fragile]
  \subslidetitle

  Change to the master branch:
   \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git checkout master}*)
\end{lstlisting}

  Do not worry, \cmd{git stash} does not loose any information, let's have a look:

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*)$ (*\textcolor[HTML]{0000AA}{git stash list}*)
stash@{0}: WIP on death-star: 2670288 add black moon
(END)
\end{lstlisting}
\end{frame}


\subsection{Preparing rebase conflict}
\begin{frame}[fragile]
  \subslidetitle

  Modify the moon.js file accordingly:
  \begin{lstlisting}
 moon( "red" );
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{moon( "white" );}*)
(*\textcolor[HTML]{00AA00}{+}*)(*\textcolor[HTML]{00AA00}{+moon( "white" ); // as snow}*)
 animate();
\end{lstlisting}

  Commit the change:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*)$ (*\textcolor[HTML]{0000AA}{git commit -a -m "snow white comment"}*)
[master 9307b0a] snow white comment
 1 file changed, 1 insertion(+), 1 deletion(-)
\end{lstlisting}
\end{frame}

\subsection{Restore stashed changes}
\begin{frame}[fragile]
  \subslidetitle

  Checkout the death-star branch:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master)}*)$ (*\textcolor[HTML]{0000AA}{git checkout death-star}*)
\end{lstlisting}
  Restore the changes from the stash queue:

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git stash pop}*)
On branch master
Changes not staged for commit:
   (use "git add <file>..." to update what will be committed)
   (use "git checkout -- <file>..." to discard changes in working directory)
       (*\textcolor[HTML]{AA0000}{modified:}*)   (*\textcolor[HTML]{AA0000}{README}*)
no changes added to commit (use "git add" and/or "git commit -a")
Dropped refs/stash@{0} (806b8f923fdcfae52c7155793da9b1f018c7d173)
\end{lstlisting}
\end{frame}

\subsection{Restore stashed changes}
\begin{frame}[fragile]
  \subslidetitle

  Commit the change:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git commit -a -m "update README"}*)
[death-star fa19da4] update README
 1 file changed, 1 insertion(+)
\end{lstlisting}

  Change to master branch:

  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(death-star)}*)$ (*\textcolor[HTML]{0000AA}{git checkout master"}*)
Switched to branch 'master'
\end{lstlisting}

\end{frame}

\subsection{Rebase Conflict}
\begin{frame}[fragile]
  \subslidetitle
  Let's rebase the death-star branch onto master:
  \begin{lstlisting}
First, rewinding head to replay your work on top of it...
Applying: change moon to blue
Using index info to reconstruct a base tree...
M	moon.js
Falling back to patching base and 3-way merge...
Auto-merging moon.js
CONFLICT (content): Merge conflict in moon.js
Failed to merge in the changes.
Patch failed at 0001 change moon to blue
...
When you have resolved this problem, run "git rebase --continue".
If you prefer to skip this patch, run "git rebase --skip" instead.
To check out the original branch and stop rebasing, run "git rebase --abort".
\end{lstlisting}
\end{frame}

\subsection{Display conflict}
\begin{frame}[fragile]
  \subslidetitle
  First we want to display the conflicting file with \cmd{git difftool}:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|REBASE 1/1)}*) $ (*\textcolor[HTML]{0000AA}{git difftool}*)
diff --cc moon.js
index 72886cb,861507e..0000000
--- a/moon.js
+++ b/moon.js
(*\textcolor[HTML]{18B2B2}{@@@ -4,7 -4,7 +4,11 @@@}*) var moons = []
  init();
  moon( "blue" );
  moon( "white" );
(*\textcolor[HTML]{00AA00}{++}*)(*\textcolor[HTML]{00AA00}{<<<<<<< HEAD}*)(*\textcolor[HTML]{00AA00}{+}*)
(*\textcolor[HTML]{00AA00}{+}*) (*\textcolor[HTML]{00AA00}{moon( "black" );}*)
(*\textcolor[HTML]{00AA00}{++}*)(*\textcolor[HTML]{00AA00}{=======}*)
(*\textcolor[HTML]{00AA00}{+}*) (*\textcolor[HTML]{00AA00}{moon( "white" ); // as snow}*)
(*\textcolor[HTML]{00AA00}{++}*)(*\textcolor[HTML]{00AA00}{>>>>>>> snow white comment}*)
  animate();
\end{lstlisting}
\end{frame}

\subsection{Resolve rebase conflict}
\begin{frame}[fragile]
  \subslidetitle
  Resolve the conflict editing the moon.js file:

  \begin{lstlisting}
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{<<<<<<< HEAD}*)
 moon( "black" );
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{=======}*)
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{moon( "white" ); // as snow}*)
(*\textcolor[HTML]{AA0000}{-}*)(*\textcolor[HTML]{AA0000}{>>>>>>> snow white comment}*)
\end{lstlisting}
  Use \cmd{git add} to stage fixed moon.js file:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|REBASE 1/1)}*) $ (*\textcolor[HTML]{0000AA}{git add moon.js}*)
\end{lstlisting}
\end{frame}

\subsection{Finish rebasing}
\begin{frame}[fragile]
  \subslidetitle
  Continue the rebase:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|REBASE 1/1)}*) $ (*\textcolor[HTML]{0000AA}{git rebase --continue}*)
Applying: snow white comment
No changes - did you forget to use 'git add'?
If there is nothing left to stage, chances are that something else
already introduced the same changes; you might want to skip this patch.
\end{lstlisting}

  As specified by git, the change was successufully applied, just finish with --skip option:
  \begin{lstlisting}
(*\textcolor[HTML]{18B2B2}{(master|REBASE 1/1)}*) $ (*\textcolor[HTML]{0000AA}{git rebase --skip}*)
\end{lstlisting}
\end{frame}
